# TechHubBot

Телеграм-бот для автоматизации процесса вступления и взаимодействия участников ИТ-Клуба. Реализован на базе `aiogram 3` и `SQLAlchemy` с поддержкой SQLite, экспортов, напоминаний и почтовых уведомлений.

## Возможности
- Регистрация пользователей в клубе с рассмотрением заявок администраторами.
- Управление профилем: изменение контактов, просмотр статуса, баллов и достижений.
- Работа с командами: создание, поиск, присоединение, приглашение и исключение участников, удаление команд.
- Каталог мероприятий: просмотр, регистрация/отмена участия, напоминания и письма-уведомления, шаблоны "онлайн/оффлайн" при создании.
- Панель администратора: обработка заявок, управление командами и мероприятиями, экспорт участников и команд в CSV/XLSX, просмотр статистики и проверка пользователей.
- Геймификация: начисление баллов за участие и автоматическая выдача достижений.
- Встроенный веб-дэшборд на FastAPI с графиками по ключевым метрикам и списком ближайших событий.
- Фото-профили для участников, команд и мероприятий с хранением `file_id` Telegram и отображением внутри бота.
- Журналирование: история решений по заявкам и изменений мероприятий (включая обновления фото).

## Быстрый старт
1. Склонируйте репозиторий и перейдите в папку проекта.
2. Создайте файл окружения из шаблона:
   ```bash
   cp .env.example .env
   ```
   При необходимости укажите SMTP-настройки для отправки писем.
3. Установите зависимости:
   ```bash
   python -m venv .venv (при ошибке на macOS используйте python3.12 -m venv .venv)
   source .venv/bin/activate  # или .venv\Scripts\activate в Windows
   pip install -r requirements.txt
   ```
4. Запустите бота:
   ```bash
   python -m bot
   ```

Для веб-панели статистики можно отдельно стартовать FastAPI:

```bash
uvicorn web.app:app --reload
```

После запуска панель доступна по адресу `http://127.0.0.1:8000/`, JSON-статистика — `/api/stats`.

По умолчанию данные сохраняются в файле `bot.db` (SQLite). Для использования другой БД обновите `DATABASE_URL` в `.env`.

## Структура
- `bot/main.py` — точка входа, инициализация бота, БД и фоновых задач.
- `bot/config.py` — настройки и работа с переменными окружения.
- `bot/db.py` и `bot/models.py` — база данных, модели и сессии SQLAlchemy.
- `bot/services/` — бизнес-логика (клуб, напоминания, email).
- `bot/handlers/` — обработчики команд и действий пользователей/администраторов (включая загрузку фото, шаблоны событий и просмотр журналов).
- `bot/keyboards/` — генерация клавиатур и кнопок.
- `bot/middlewares/` — DI-подключение сессий базы данных для обработчиков.

## Дополнительно
- Напоминания по мероприятиям отправляются в личные сообщения и (при наличии SMTP) на email за `REMINDER_HOURS_BEFORE` часов до начала.
- Экспорт данных сохраняет файлы в папке `exports/` и отправляет их администраторам.
- При отсутствии SMTP-настроек email-уведомления тихо игнорируются (отмечается в логах).
- Изменяйте `POINTS_PER_EVENT`, чтобы настроить систему баллов.
- Шаблоны мероприятий выбираются из меню при создании (`Онлайн`/`Оффлайн` или свободный ввод). Историю изменений можно посмотреть командой `История мероприятия <id>`, обновить фото — `Фото мероприятия <id>`.
- По заявкам доступны журналы решений: команда `История заявки <id>` показывает все одобрения/отказы с комментариями.
- Для обновления фото: профиль пользователя (`Обновить фото`), команды (`Обновить фото` в карточке команды) и мероприятия (команда чата). Просмотр фото доступен из карточек и кнопок `Фото`.

## Тестовая учётная запись администратора
- Администратор: `1120488403`
- Токен бота указан в `.env.example`.

Для интеграции с продакшн-окружением настройте хранение токена и SMTP-данных через переменные окружения и замените SQLite на предпочитаемую СУБД.
